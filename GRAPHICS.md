# Работа с графикой NES

## Формат CHR ROM

CHR ROM (Character ROM) содержит графические данные для NES - спрайты и тайлы фона.

### Структура тайла

Каждый тайл NES имеет размер **8×8 пикселей** и занимает **16 байт** в памяти:
- Первые 8 байт - **низкая битовая плоскость** (low bitplane)
- Вторые 8 байт - **высокая битовая плоскость** (high bitplane)

### Декодирование пикселя

Каждый пиксель кодируется **2 битами** (значение 0-3), которые определяют индекс в палитре:

```
Пиксель = (HighBit << 1) | LowBit
```

Где:
- **LowBit** - бит из первой битовой плоскости
- **HighBit** - бит из второй битовой плоскости

### Пример

Байты тайла (16 байт):
```
Low bitplane:  [0x41, 0x22, 0x14, 0x08, 0x14, 0x22, 0x41, 0x00]
High bitplane: [0x00, 0x3C, 0x66, 0xC3, 0xC3, 0x66, 0x3C, 0x00]
```

Для пикселя в позиции (x=0, y=0):
- Low bit из байта 0, бит 7: `(0x41 >> 7) & 1 = 0`
- High bit из байта 8, бит 7: `(0x00 >> 7) & 1 = 0`
- Результат: `(0 << 1) | 0 = 0` (прозрачный/фоновый цвет)

## Палитры NES

### Цветовая система

NES использует палитру из **64 возможных цветов**, но в каждый момент времени может отображать только **25 цветов** одновременно:
- 1 универсальный фоновый цвет
- 4 палитры для фона (по 3 цвета)
- 4 палитры для спрайтов (по 3 цвета)

### Индексы в тайле

Каждый пиксель тайла хранит индекс **0-3**:
- **0** - обычно прозрачный или фоновый цвет
- **1-3** - индексы в выбранной палитре

### Палитры в NesExtractor

#### ⚠️ ВАЖНО: Палитры НЕ хранятся в .NES файле!

**Почему нет палитр в ROM?**
- CHR ROM содержит только индексы цветов (0-3) для каждого пикселя
- Палитры загружаются игрой программно в PPU память во время выполнения
- Разные игры используют разные палитры для одних и тех же тайлов
- В .NES файле нет информации о палитрах

**Что делают правильные редакторы?**
- YY-CHR, Tile Molester и другие показывают CHR ROM в **greyscale** (честный способ)
- Или дают пользователю выбрать палитру вручную для визуализации

#### Режим Greyscale (по умолчанию) ✅

**Самый честный способ** показать содержимое CHR ROM:
```
0: Черный (фон)
1: Темно-серый
2: Светло-серый
3: Белый
```

Это показывает реальные индексы 0-3 без каких-либо предположений о цвете.

#### Стандартная палитра NES (64 цвета)

В NesExtractor реализована полная аппаратная палитра NES на основе спецификации PPU 2C02:
- Палитра содержит **64 цвета** (0x00 - 0x3F)
- Соответствует оригинальным цветам NES

#### Предустановленные палитры для визуализации (опционально)

Для красоты доступно **9 дополнительных палитр**:

1. **Greyscale** (по умолчанию) - честный способ ✅
2. **Нейтральная** - серо-белые оттенки из палитры NES
3. **Синяя** - оттенки синего
4. **Красная** - оттенки красного
5. **Зеленая** - оттенки зеленого
6. **Желтая** - оттенки желтого
7. **Фиолетовая** - оттенки фиолетового
8. **Бирюзовая** - оттенки бирюзового
9. **Оранжевая** - оттенки оранжевого
10. **Радужная** - разные цвета

Каждая палитра содержит 4 цвета из основной палитры NES (64 цвета).

#### Прозрачность (опционально)

**Чекбокс "Прозрачность"** позволяет:
- Показать индекс 0 как прозрачный цвет
- Отобразить шахматный фон (как в Photoshop)
- Увидеть, где находятся "пустые" пиксели

**По умолчанию прозрачность выключена**, так как в NES индекс 0 - это просто цвет фона, а не прозрачность.

## Реализация в NesExtractor

### Класс NesTile

```csharp
public class NesTile
{
    public const int TileSize = 8;           // 8×8 пикселей
    public const int TileSizeInBytes = 16;   // 16 байт на тайл
    
    public byte[,] Pixels { get; set; }      // Массив 8×8 со значениями 0-3
}
```

### Декодирование

```csharp
for (int y = 0; y < 8; y++)
{
    byte lowByte = data[y];        // Первые 8 байт
    byte highByte = data[y + 8];   // Вторые 8 байт
    
    for (int x = 0; x < 8; x++)
    {
        int bitPos = 7 - x;  // MSB first
        int lowBit = (lowByte >> bitPos) & 1;
        int highBit = (highByte >> bitPos) & 1;
        
        Pixels[y, x] = (byte)((highBit << 1) | lowBit);
    }
}
```

### Рендеринг

Используется **SkiaSharp** для создания изображений:
1. Создается SKBitmap нужного размера
2. Каждый пиксель рисуется квадратом с цветом из палитры
3. **IsAntialias = false** для сохранения пиксельной графики
4. **RenderOptions.BitmapInterpolationMode = None** в Avalonia

## Панно тайлов

### Структура

- По умолчанию **16 тайлов в ряду**
- Масштаб тайла: **2x** (16×16 пикселей)
- Спейсинг: **1 пиксель** между тайлами
- Фон: темно-серый (#202020)

### Расчет размера панно

```csharp
int scaledTileSize = TileSize * TileScale;  // 8 * 2 = 16
int tileWithSpacing = scaledTileSize + Spacing;  // 16 + 1 = 17
int rows = (int)Math.Ceiling(tiles.Count / (double)TilesPerRow);
int width = TilesPerRow * tileWithSpacing - Spacing;
int height = rows * tileWithSpacing - Spacing;
```

## Экспорт

### Экспорт панно

Создается PNG файл со всеми тайлами:
```csharp
ChrRomExtractor.ExportTileSheet(bitmap, "output.png");
```

### Экспорт отдельных тайлов

Создается папка с PNG файлами для каждого тайла:
- Имя файла: `tile_0000.png`, `tile_0001.png` и т.д.
- Масштаб: 4x (32×32 пикселя) для лучшего качества
- Формат: PNG с прозрачностью

## Технические ограничения

### Текущая реализация

- ✅ Декодирование 2-битных тайлов (стандарт NES)
- ✅ Greyscale палитра (универсальная)
- ✅ Масштабирование без размытия
- ✅ Экспорт в PNG

### Не реализовано

- ❌ Выбор цветовых палитр NES
- ❌ Применение нескольких палитр к разным областям
- ❌ Отображение атрибутов (какой тайл использует какую палитру)
- ❌ Анимация (чередование банков CHR)
- ❌ Редактирование тайлов

## Полезные ссылки

- [NES CHR format](https://www.nesdev.org/wiki/CHR_ROM)
- [PPU pattern tables](https://www.nesdev.org/wiki/PPU_pattern_tables)
- [NES palette](https://www.nesdev.org/wiki/PPU_palettes)

## Примеры игр

| Игра | CHR ROM | Количество тайлов | Особенности |
|------|---------|-------------------|-------------|
| Super Mario Bros | 8 KB | 512 тайлов | Иконичные спрайты Марио |
| Mega Man | 0 KB (CHR RAM) | - | Использует RAM вместо ROM |
| Castlevania | 128 KB | 8192 тайла | Большое количество графики |
| Duck Hunt | 8 KB | 512 тайлов | Простая графика для Gun |

